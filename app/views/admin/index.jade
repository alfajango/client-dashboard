extends ../layouts/application

block sidebar
  ul.nav.flex-column
    li.nav-item
      a.nav-link(href="/admin",class=(archived ? "" : "active"))
        | Clients
    li.nav-item
      a.nav-link(href="/admin?archived=true", class=(archived ? "active" : ""))
        | Archived
block content
  .d-flex.flex-wrap.py-1.pt-3.border-bottom.mb-4
    - headerText = archived ? "Archived Clients" : "Clients"
    h1= headerText

  .container-fluid.g-0.container-content.mb-5
    each client in clients
      - projectPaneId = `project-pane-${client.id}`
      - usersPaneId = `users-pane-${client.id}`
      - managePaneId = `settings-pane-${client.id}`
      .row.mb-2
        .col-sm
          h3.client-name.aj-color-green= client.name

      ul.nav.nav-pills.nav-pills-sm.mb-2(role="tablist")
        li.nav-item
          a.nav-link.active('data-bs-toggle'='tab','data-bs-target'=`#${projectPaneId}`) Projects
        li.nav-item
          a.nav-link('data-bs-toggle'='tab','data-bs-target'=`#${usersPaneId}`) Users
        li.nav-item.dropdown
          a.nav-link.dropdown-toggle('data-bs-toggle'='dropdown') Manage
          ul.dropdown-menu
            li
              .dropdown-item
                a.btn.btn-sm(href="/admin/clients/#{client.id}/projects/new")
                  |  Add Project

              .dropdown-item
                form(action='/admin/clients/' + client.id + '/copy', method="POST")
                  input.btn.btn-sm(type="submit", value="Copy")

              .dropdown-item
                a.btn.btn-sm(href="/admin/clients/#{client.id}/edit")
                  |  Edit Client
              
              .dropdown-item
                form(action='/admin/clients/' + client.id + '/archive', method="POST")
                  input(type="hidden", name="_method", value="PUT")
                  input.btn.btn-sm(type="submit", value=(client.archived ? "Unarchive" : "Archive"))
              
              .dropdown-item
                form(action='/admin/clients/' + client.id, method="POST")
                  input(type="hidden", name="_method", value="DELETE")
                  input.btn.btn-sm(type="submit", value="Delete", onclick="return confirm('Are you sure you want to delete this client and all projects and services?')")


      .tab-content.mb-4
        .tab-pane.fade.show.active('id'=projectPaneId)
          - if (client.projects)
            - for project in client.projects
              - bgColor = project.headerBG || "#eee";
              div(style="background-image: linear-gradient(#{bgColor}, white); color: #{project.headerColor};")
                .card.bg-semi-transparent.rounded-0
                  .card-header
                    .row
                      .col
                        = project.name
                      .col-2.text-end
                        .dropdown
                          a.btn.btn-sm.py-0.dropdown-toggle('data-bs-toggle'='dropdown', href='#')
                            | Edit
                            span.caret
                          ul.dropdown-menu
                            li
                              a.dropdown-item(href="/admin/clients/#{client.id}/projects/#{project._id}/edit")
                                small
                                  i.bi.bi-pencil.pe-2
                                  |  Edit Project
                            li
                              a.dropdown-item(href="/admin/clients/#{client.id}/projects/#{project.id}/services/new")
                                small
                                  i.bi.bi-plus-lg.pe-2
                                  |  Add Service
                  .card-body
                    - if (project.services)
                      ul.list-unstyled.mb-0
                        - for service in project.services
                          li.py-2
                            = service.name
                            .btn-group.float-end
                              a.btn.aj-btn-tight(href="/admin/clients/#{client.id}/projects/#{project.id}/services/#{service.id}/edit")
                                i.bi.bi-pencil
                              form.pull-right(action='/admin/clients/' + client.id + '/projects/' + project.id + '/services' + (service ? ('/' + service.id) : ""), method="POST")
                                input(type="hidden", name="_method", value="DELETE")
                                button.btn.aj-btn-tight.text-danger(type="submit", onclick="return confirm('Are you sure?')",)
                                  i.bi.bi-x-circle
        .tab-pane.fade('id'=usersPaneId)
          - if (users[client.id])
            ul.list-unstyled.p-3
              - for user in users[client.id]
                li.clearfix
                  = user.email
                    a.btn.btn-mini.pull-right(href="/admin/users/#{user.id}/edit")
                      i.bi.bi-pencil

                  if user.admin
                    .badge.bg-info.rounded-pill admin
                  
                  if user.id == currentUser.id
                    .badge.bg-warning.rounded-pill you


        .tab-pane.fade('id'=managePaneId)
          .row
            .col 
              a.btn.btn-outline-secondary.btn-block Edit Client
            .col 
              a.btn.btn-outline-secondary.btn-block Add Project
            .col 
              a.btn.btn-outline-secondary.btn-block Copy Client
            .col 
              a.btn.btn-outline-secondary.btn-block Archive Client
            .col 
              a.btn.btn-outline-secondary.btn-block Delete Client

  .container-fluid.g-0
    each client in clients
      .row.mb-3
        .col-sm
          .row.pt-3
            .col-sm
              a(href="/?client_id=#{client.id}")= client.name
            .col-sm
              .btn-toolbar.justify-content-end
                .btn-group.btn-group-sm
                  a.btn.btn-outline-secondary.dropdown-toggle('data-bs-toggle'='dropdown', href='#')
                    | Edit
                  ul.dropdown-menu
                    li
                      a.dropdown-item(href="/admin/clients/#{client.id}/edit")
                        small
                          i.bi.bi-pencil.pe-2
                          |  Edit Client
                    li
                      a.dropdown-item(href="/admin/clients/#{client.id}/projects/new")
                        small
                          i.bi.bi-plus-lg.pe-2
                          |  Add Project
                  a.btn.btn-outline-secondary.dropdown-toggle('data-bs-toggle'='dropdown', href='#')
                    | Manage
                  ul.dropdown-menu
                    li
                      .dropdown-item
                        form(action='/admin/clients/' + client.id + '/copy', method="POST")
                          input.btn(type="submit", value="Copy")
                    li
                      .dropdown-item
                        form(action='/admin/clients/' + client.id + '/archive', method="POST")
                          input(type="hidden", name="_method", value="PUT")
                          input.btn(type="submit", value=(client.archived ? "Unarchive" : "Archive"))
                    li
                      .dropdown-item
                        form(action='/admin/clients/' + client.id, method="POST")
                          input(type="hidden", name="_method", value="DELETE")
                          input.btn.btn-danger(type="submit", value="Delete", onclick="return confirm('Are you sure you want to delete this client and all projects and services?')")

          - if (users[client.id])
            ul.list-unstyled.mt-4
              - for user in users[client.id]
                li.clearfix
                  = user.email
                    a.btn.btn-mini.pull-right(href="/admin/users/#{user.id}/edit")
                      i.bi.bi-pencil

                  if user.admin
                    .badge.bg-info.rounded-pill admin
                  
                  if user.id == currentUser.id
                    .badge.bg-warning.rounded-pill you


        .col-sm
          - if (client.projects)
              ul.list-group
                - for project in client.projects
                  - bgColor = project.headerBG || "#eee";
                  li.list-group-item.px-2.border-0(style="background-image: linear-gradient(#{bgColor}, white); color: #{project.headerColor};")
                    .card.bg-semi-transparent.rounded-0
                      .card-header
                        .row
                          .col
                            = project.name
                          .col-2.text-end
                            .dropdown
                              a.btn.btn-sm.py-0.dropdown-toggle('data-bs-toggle'='dropdown', href='#')
                                | Edit
                                span.caret
                              ul.dropdown-menu
                                li
                                  a.dropdown-item(href="/admin/clients/#{client.id}/projects/#{project._id}/edit")
                                    small
                                      i.bi.bi-pencil.pe-2
                                      |  Edit Project
                                li
                                  a.dropdown-item(href="/admin/clients/#{client.id}/projects/#{project.id}/services/new")
                                    small
                                      i.bi.bi-plus-lg.pe-2
                                      |  Add Service
                      .card-body
                        - if (project.services)
                          ul.list-unstyled
                            - for service in project.services
                              li.py-2
                                = service.name
                                .btn-group.float-end
                                  a.btn.aj-btn-tight(href="/admin/clients/#{client.id}/projects/#{project.id}/services/#{service.id}/edit")
                                    i.bi.bi-pencil
                                  form.pull-right(action='/admin/clients/' + client.id + '/projects/' + project.id + '/services' + (service ? ('/' + service.id) : ""), method="POST")
                                    input(type="hidden", name="_method", value="DELETE")
                                    button.btn.aj-btn-tight.text-danger(type="submit", onclick="return confirm('Are you sure?')",)
                                      i.bi.bi-x-circle

  - if (users['not assigned'])
    h2 Unassigned Users
    ul
      - for user in users['not assigned']
        li
          = user.email
          |
          if user.admin
            span.label.label-info admin
            |
          if user.id == currentUser.id
            span.label.label-warning you
            |
          | -
          a.btn.btn-mini(href="/admin/users/#{user.id}/edit") Edit
          if user.id != currentUser.id
            form.form-inline(action='/admin/users/' + user.id, method="POST")
              input(type="hidden", name="_method", value="DELETE")
              input.btn.btn-mini.btn-danger(type="submit", value="Delete", onclick="return confirm('Are you sure you want to delete user #{user.email}?')")
