extends ../layouts/application

block head
  script
    function addCommas(nStr) {
      nStr += '';
      x = nStr.split('.');
      x1 = x[0];
      x2 = x.length > 1 ? '.' + x[1] : '';
      var rgx = /(\d+)(\d{3})/;
      while (rgx.test(x1)) {
        x1 = x1.replace(rgx, '$1' + ',' + '$2');
      }
      return x1 + x2;
    }

    function stringToUrl(str) {
      var url = document.createElement('a');
      url.href = str;
      return url;
    }

    var socket = io.connect(location.protocol + '//' + location.host);
    var emitters = {};

  each service in project.services
    script
      socket.on('serviceResponse', function(data) {
        if (data["#{service.name}"]) {
          widgets["#{service.name}"].call(this, data, jQuery);
        }
      });

  each service in project.services
    script
      emitters["#{service.name}"] = function() {
        socket.emit('service', {client: "#{theClient.id}", project: "#{project.id}", service: "#{service.name}"});
      };
      emitters["#{service.name}"]();

  script
    $(document).delegate('.refresh-service', 'click', function(e) {
      var $this = $(this),
          service = $this.data('service');
      $this.addClass('disabled').text('Refreshing...');
      emitters[service]();
    });
    $(document).delegate('.errbit-description-toggle', 'click', function(e) {
      $(this).siblings('.errbit-description').slideToggle();
    });

block header
  - if (project.imageURL)
    .pull-right
      img(src=project.imageURL, height="60px")

  h1= title
  p Welcome to #{project.name}'s real-time tech status dashboard

block content

  - if (project.hasService('redmine_open_issues'))
    .pull-right
      i.icon-ok.refresh-ok.pull-left
      button.btn.btn-small.refresh-service('data-service'='redmine_open_issues')
        i.icon-retweet
    h2#redmine-title
      | Open Tasks 
      span.badge
    table.table.table-bordered#redmine
      thead
        tr
          th.redmine-ticket-td Ticket
          th Description
          th.redmine-status-td Status
      tbody
        tr
          td(colspan=3)
            .loading.large
              | Loading 
              img(src="/images/ajax-loader.gif")

  .row-fluid
    .span8
      - if (project.hasService('errbit_unresolved_exceptions'))
        .pull-right
          i.icon-ok.refresh-ok.pull-left
          button.btn.btn-small.refresh-service('data-service'='errbit_unresolved_exceptions')
            i.icon-retweet
        h2#errbit-title
          | Unresolved Errors 
          span.badge
        table.table.table-bordered#errbit
          thead
            tr
              th Affecting
              th Occurrences
              th Last Occurred
          tbody
            td(colspan=4)
              .loading.large
                | Loading 
                img(src="/images/ajax-loader.gif")

    .span4
      - if (project.hasService('cashboard_uninvoiced_amounts'))
        .pull-right
          i.icon-ok.refresh-ok.pull-left
          button.btn.btn-small.refresh-service('data-service'='cashboard_uninvoiced_amounts')
            i.icon-retweet
        h2 Invoice Amount
        table.table.table-bordered#cashboard
          tr
            th Uninvoiced Time
            td#invoice.right-align
              .loading
                | Loading 
                img(src="/images/ajax-loader-small.gif")
          tr
            th Uninvoiced Expenses
            td#expenses.right-align
              .loading
                | Loading 
                img(src="/images/ajax-loader-small.gif")

    .span4
      - if (project.hasService('aremysitesup_instant_status'))
        .pull-right
          i.icon-ok.refresh-ok.pull-left
          button.btn.btn-small.refresh-service('data-service'='aremysitesup_instant_status')
            i.icon-retweet
        h2 Site Status
        table.table.table-bordered#aremysitesup
          tr
            td.aremysitesup-status
              .loading
                | Loading 
                img(src="/images/ajax-loader-small.gif")
