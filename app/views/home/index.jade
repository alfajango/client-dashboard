extends ../layouts/application

block head
  script
    function addCommas(nStr) {
      nStr += '';
      x = nStr.split('.');
      x1 = x[0];
      x2 = x.length > 1 ? '.' + x[1] : '';
      var rgx = /(\d+)(\d{3})/;
      while (rgx.test(x1)) {
        x1 = x1.replace(rgx, '$1' + ',' + '$2');
      }
      return x1 + x2;
    }

    var socket = io.connect(location.protocol + '//' + location.host);
    var emitters = {};

    socket.on('serviceResponse', function(data) {
      if (data.redmine) {
        var rows = "";
        var now = new Date(),
            yesterday = now - (1000 * 60 * 60 * 24);
        if (data.redmine.length > 0) {
          $.each(data.redmine, function(i, issue) {
            var updated = +(new Date(issue.updated)); // Make sure both dates are compared as integers
            rows += '<tr' + (updated > yesterday ? ' class="recently-updated" rel="tooltip" title="recently active"' : '') + '>';
            rows += '<td>' + issue.id + '</td>';
            rows += '<td>' + issue.subject + '</td>';
            rows += '<td>' + issue.status + '</td>';
            rows += '<td>';
            if (issue.progress > 0) {
              rows += '<div class="progress progress-striped"><div class="bar" style="width: ' + issue.progress + '%;"></div>'
            }
            rows += '</td>';
            rows += '</tr>';
          });
        } else {
          rows += '<tr><td colspan=4><div class="alert alert-success">No current tasks</div></td></tr>';
        }
        $('#redmine tbody').html(rows);
        $('#redmine tr').tooltip({placement: 'bottom'});
        $('#redmine-title .badge').html(data.redmine.length);
        $('.refresh-service[data-service="redmine"]').removeClass('disabled').text('Refresh').siblings('.refresh-ok').show().delay('250').fadeOut();
      } else if (data.cashboard) {
        $('#invoice').html('$' + addCommas(data.cashboard.invoice));
        $('#expenses').html('$' + addCommas(data.cashboard.expenses));
        $('.refresh-service[data-service="cashboard"]').removeClass('disabled').text('Refresh').siblings('.refresh-ok').show().delay('250').fadeOut();
      } else if (data.errbit) {
        var rows = "";
        if (data.errbit.length > 0) {
          $.each(data.errbit, function(i, exception) {
            rows += '<tr>';
            rows += '<td>' + exception.title + '</td>';
            rows += '<td>' + exception.env + '</td>';
            rows += '<td>' + exception.count + '</td>';
            rows += '<td>' + (humaneDate(exception.last_occurrence) || exception.last_occurrence) + '</td>';
            rows += '</tr>';
          });
        } else {
          rows += '<tr><td colspan=4><div class="alert alert-success">No unresolved errors <i class="icon-thumbs-up"></i></div></td></tr>';
        }
        $('#errbit tbody').html(rows);
        $('#errbit-title .badge')
          .html(data.errbit.length)
          .removeClass('badge-success').removeClass('badge-warning')
          .addClass(data.errbit.length === 0 ? 'badge-success' : 'badge-warning');
        $('.refresh-service[data-service="errbit"]').removeClass('disabled').text('Refresh').siblings('.refresh-ok').show().delay('250').fadeOut();
      }
    });

  each service in project.services
    script
      emitters["#{service.name}"] = function() {
        socket.emit('service', {client: "#{theClient.id}", project: "#{project.id}", service: "#{service.name}"});
      };
      emitters["#{service.name}"]();

  script
    $(document).delegate('.refresh-service', 'click', function(e) {
      var $this = $(this),
          service = $this.data('service');
      $this.addClass('disabled').text('Refreshing...');
      emitters[service]();
    });

block header
  - if (project.imageURL)
    .pull-right
      img(src=project.imageURL, height="60px")

  h1= title
  p Welcome to #{project.name}'s real-time tech status dashboard

block content

  - if (project.hasService('redmine'))
    .pull-right
      i.icon-ok.refresh-ok.pull-left
      button.btn.refresh-service('data-service'='redmine') Refresh
    h2#redmine-title
      | Current Tasks 
      span.badge
    table.table.table-bordered#redmine
      thead
        tr
          th Ticket
          th Description
          th Status
          th % Done
      tbody
        tr
          td(colspan=4)
            .loading.large
              | Loading 
              img(src="/images/ajax-loader.gif")

  - if (project.hasService('errbit'))
    .pull-right
      i.icon-ok.refresh-ok.pull-left
      button.btn.refresh-service('data-service'='errbit') Refresh
    h2#errbit-title
      | Unresolved Errors 
      span.badge
    table.table.table-bordered#errbit
      thead
        tr
          th Error
          th Environment
          th Occurrences
          th Last Occurrence
      tbody
        td(colspan=4)
          .loading.large
            | Loading 
            img(src="/images/ajax-loader.gif")

  - if (project.hasService('cashboard'))
    .row-fluid
      .span6
        .pull-right
          i.icon-ok.refresh-ok.pull-left
          button.btn.refresh-service('data-service'='cashboard') Refresh
        h2 Invoice Amount
        table.table.table-bordered#cashboard
          tr
            th Uninvoiced Time
            td#invoice.right-align
              .loading
                | Loading 
                img(src="/images/ajax-loader-small.gif")
          tr
            th Uninvoiced Expenses
            td#expenses.right-align
              .loading
                | Loading 
                img(src="/images/ajax-loader-small.gif")
