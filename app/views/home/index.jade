extends ../layouts/application

block head
  script
    var socket = io.connect('http://localhost:3000');

    socket.on('serviceResponse', function(data) {
      if (data.redmine) {
        var rows = "";
        $.each(data.redmine, function(i, issue) {
          rows += '<tr>';
          rows += '<td>' + issue.id + '</td>';
          rows += '<td>' + issue.subject + '</td>';
          rows += '<td>' + issue.status + '</td>';
          rows += '<td>';
          if (issue.progress > 0) {
            rows += '<div class="progress progress-striped"><div class="bar" style="width: ' + issue.progress + '%;"></div>'
          }
          rows += '</td>';
          rows += '</tr>';
        });
        $('#redmine tbody').html(rows);
        $('#redmine-title').append('<span class="badge">' + data.redmine.length + '</span>');
      } else if (data.cashboard) {
        $('#invoice').html(data.cashboard.invoice);
        $('#expenses').html(data.cashboard.expenses);
      } else if (data.errbit) {
        var rows = "";
        $.each(data.errbit, function(i, exception) {
          rows += '<tr>';
          rows += '<td>' + exception.title + '</td>';
          rows += '<td>' + exception.updated + '</td>';
          rows += '<td>' + exception.env + '</td>';
          rows += '</tr>';
        });
        $('#errbit tbody').html(rows);
        $('#errbit-title').append('<span class="badge badge-warning">' + data.errbit.length + '</span>');
      }
    });

  each service in project.services
    script
      socket.emit('service', {client: "#{theClient.id}", project: "#{project.id}", service: "#{service.name}"});

block content
  h1= title
  p Welcome to #{title}

  - if (project.hasService('redmine'))
    h2#redmine-title Current Issues
    table.table.table-bordered#redmine
      thead
        tr
          th Ticket
          th Description
          th Status
          th % Done
      tbody
        tr
          td(colspan=4)
            .loading.large
              | Loading 
              img(src="/images/ajax-loader.gif")

  - if (project.hasService('errbit'))
    h2#errbit-title Unresolved Exceptions
    table.table.table-bordered#errbit
      thead
        tr
          th Exception
          th Latest time encountered
          th Environment
      tbody
        td(colspan=3)
          .loading.large
            | Loading 
            img(src="/images/ajax-loader.gif")

  - if (project.hasService('cashboard'))
    h2 Invoice Amount
    table.table.table-bordered#cashboard
      tr
        th Uninvoiced Time
        td#invoice
          .loading
            | Loading 
            img(src="/images/ajax-loader-small.gif")
      tr
        th Uninvoiced Expenses
        td#expenses
          .loading
            | Loading 
            img(src="/images/ajax-loader-small.gif")
